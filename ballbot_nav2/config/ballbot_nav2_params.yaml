amcl:
    ros__parameters:
        use_sim_time: True
        # set_initial_pose: true
        # initial_pose:
        #     x: 0.0
        #     y: -0.2
        #     z: 0.0
        #     yaw: 0.0

bt_navigator:
    ros__parameters:
        use_sim_time: True
        global_frame: map
        robot_base_frame: base_footprint
        odom_topic: /odom
        bt_loop_duration: 10
        default_server_timeout: 20

controller_server:
    ros__parameters:
        use_sim_time: True
        controller_frequency: 20.0
        min_x_velocity_threshold: 0.001
        min_y_velocity_threshold: 0.5
        min_theta_velocity_threshold: 0.001
        failure_tolerance: 0.3
        progress_checker_plugin: "progress_checker"
        goal_checker_plugins: ["general_goal_checker"]
        controller_plugins: ["FollowPath"]

        progress_checker:
            plugin: "nav2_controller::SimpleProgressChecker"
            required_movement_radius: 0.3
            movement_time_allowance: 15.0

        general_goal_checker:
            stateful: True
            plugin: "nav2_controller::SimpleGoalChecker"
            xy_goal_tolerance: 0.3
            yaw_goal_tolerance: 0.3

        FollowPath:
            plugin: "dwb_core::DWBLocalPlanner"
            min_vel_x: 0.0
            min_vel_y: 0.0
            max_vel_x: 0.4
            max_vel_y: 0.0
            max_vel_theta: 0.8
            min_speed_xy: 0.0
            max_speed_xy: 0.4
            min_speed_theta: 0.0
            acc_lim_x: 1.5
            acc_lim_y: 0.0
            acc_lim_theta: 2.0
            decel_lim_x: -1.5
            decel_lim_y: 0.0
            decel_lim_theta: -2.0
            vx_samples: 20
            vy_samples: 1
            vtheta_samples: 20
            sim_time: 2.0
            linear_granularity: 0.05
            angular_granularity: 0.025
            transform_tolerance: 0.5
            xy_goal_tolerance: 0.3
            trans_stopped_velocity: 0.25
            short_circuit_trajectory_evaluation: True
            stateful: True
            critics: ["RotateToGoal", "Oscillation", "BaseObstacle", "GoalAlign", "PathAlign", "PathDist", "GoalDist"]
            BaseObstacle.scale: 0.02
            PathAlign.scale: 32.0
            PathAlign.forward_point_distance: 0.1
            GoalAlign.scale: 24.0
            GoalAlign.forward_point_distance: 0.1
            PathDist.scale: 32.0
            GoalDist.scale: 24.0
            RotateToGoal.scale: 32.0
            RotateToGoal.slowing_factor: 5.0
            RotateToGoal.lookahead_time: -1.0

local_costmap:
    local_costmap:
        ros__parameters:
            update_frequency: 5.0
            publish_frequency: 2.0
            global_frame: odom
            robot_base_frame: base_footprint
            use_sim_time: True
            rolling_window: true
            width: 3
            height: 3
            resolution: 0.05
            # UPDATED: Robot footprint to match actual dimensions
            # Robot is 1.0m long (0.65m arms + 0.25m flaps + 0.15m chassis front)
            # and 0.70m wide (0.65m chassis + arm clearance)
            # Format: [[front_left_x, front_left_y], [front_right_x, front_right_y],
            #          [back_right_x, back_right_y], [back_left_x, back_left_y]]
            footprint: "[[1.0, 0.35], [1.0, -0.35], [-0.27, -0.35], [-0.27, 0.35]]"
            plugins: ["voxel_layer", "inflation_layer"]
            inflation_layer:
                plugin: "nav2_costmap_2d::InflationLayer"
                cost_scaling_factor: 3.0
                # UPDATED: Increased inflation radius to give more clearance
                inflation_radius: 0.80
            voxel_layer:
                plugin: "nav2_costmap_2d::VoxelLayer"
                enabled: True
                publish_voxel_map: True
                origin_z: 0.0
                z_resolution: 0.05
                z_voxels: 16
                max_obstacle_height: 2.0
                mark_threshold: 0
                observation_sources: scan
                scan:
                    topic: /scan
                    max_obstacle_height: 2.0
                    clearing: True
                    marking: True
                    data_type: "LaserScan"
                    raytrace_max_range: 3.0
                    raytrace_min_range: 0.0
                    obstacle_max_range: 2.5
                    obstacle_min_range: 0.0

global_costmap:
    global_costmap:
        ros__parameters:
            update_frequency: 1.0
            publish_frequency: 1.0
            global_frame: map
            robot_base_frame: base_footprint
            use_sim_time: True
            # UPDATED: Using footprint instead of robot_radius
            footprint: "[[1.0, 0.35], [1.0, -0.35], [-0.27, -0.35], [-0.27, 0.35]]"
            resolution: 0.05
            track_unknown_space: true
            plugins: ["static_layer", "obstacle_layer", "inflation_layer"]
            obstacle_layer:
                plugin: "nav2_costmap_2d::ObstacleLayer"
                enabled: True
                observation_sources: scan
                scan:
                    topic: /scan
                    max_obstacle_height: 2.0
                    clearing: True
                    marking: True
                    data_type: "LaserScan"
                    raytrace_max_range: 3.0
                    raytrace_min_range: 0.0
                    obstacle_max_range: 2.5
                    obstacle_min_range: 0.0
            static_layer:
                plugin: "nav2_costmap_2d::StaticLayer"
                map_subscribe_transient_local: True
            inflation_layer:
                plugin: "nav2_costmap_2d::InflationLayer"
                cost_scaling_factor: 3.0
                # UPDATED: Increased inflation radius
                inflation_radius: 0.80

map_server:
    ros__parameters:
        use_sim_time: True
        yaml_filename: ""

planner_server:
    ros__parameters:
        expected_planner_frequency: 10.0
        use_sim_time: True
        planner_plugins: ["GridBased"]
        GridBased:
            plugin: "nav2_navfn_planner::NavfnPlanner"
            tolerance: 0.5
            use_astar: false
            allow_unknown: true

smoother_server:
    ros__parameters:
        use_sim_time: True
        smoother_plugins: ["simple_smoother"]
        simple_smoother:
            plugin: "nav2_smoother::SimpleSmoother"
            tolerance: 1.0e-10
            max_its: 1000
            do_refinement: True

behavior_server:
    ros__parameters:
        costmap_topic: local_costmap/costmap_raw
        footprint_topic: local_costmap/published_footprint
        cycle_frequency: 10.0
        behavior_plugins: ["spin", "backup", "drive_on_heading", "wait"]
        spin:
            plugin: "nav2_behaviors::Spin"
        backup:
            plugin: "nav2_behaviors::BackUp"
        drive_on_heading:
            plugin: "nav2_behaviors::DriveOnHeading"
        wait:
            plugin: "nav2_behaviors::Wait"
        global_frame: odom
        robot_base_frame: base_footprint
        transform_tolerance: 0.5
        use_sim_time: True
        simulate_ahead_time: 2.0
        max_rotational_vel: 0.8
        min_rotational_vel: 0.4
        rotational_acc_lim: 2.0

waypoint_follower:
    ros__parameters:
        use_sim_time: True
        loop_rate: 20
        stop_on_failure: false
        waypoint_task_executor_plugin: "wait_at_waypoint"
        wait_at_waypoint:
            plugin: "nav2_waypoint_follower::WaitAtWaypoint"
            enabled: True
            waypoint_pause_duration: 200

velocity_smoother:
    ros__parameters:
        use_sim_time: True
        smoothing_frequency: 20.0
        scale_velocities: False
        feedback: "OPEN_LOOP"
        max_velocity: [0.4, 0.0, 0.8]
        min_velocity: [-0.4, 0.0, -0.8]
        max_accel: [1.5, 0.0, 2.0]
        max_decel: [-1.5, 0.0, -2.0]
        odom_topic: "odom"
        odom_duration: 0.1
        deadband_velocity: [0.0, 0.0, 0.0]
        velocity_timeout: 1.0
# collision_monitor:
#     ros__parameters:
#         use_sim_time: True
#         base_frame_id: "base_footprint"
#         odom_frame_id: "odom"

#         # Command velocity topics
#         cmd_vel_in_topic: "cmd_vel_smoothed" # Input from velocity smoother
#         cmd_vel_out_topic: "cmd_vel" # Output to your relay

#         state_topic: "collision_monitor_state"
#         transform_tolerance: 0.5
#         source_timeout: 1.0
#         base_shift_correction: True
#         stop_pub_timeout: 2.0

#         # Observation sources - lidar only
#         observation_sources: ["scan"]

#         scan:
#             type: "scan"
#             topic: "/scan"
#             min_height: 0.05
#             max_height: 2.0
#             enabled: True

#         # Define safety polygons around the robot
#         polygons: ["FootprintStop", "FootprintApproach", "FootprintSlow"]

#         # STOP ZONE - Immediate emergency stop (20cm around robot)
#         FootprintStop:
#             type: "polygon"
#             action_type: "stop"
#             min_points: 4
#             visualize: True
#             polygon_pub_topic: "polygon_stop"
#             # Rectangle around robot: [front-left, front-right, back-right, back-left]
#             # Your robot is about 0.65m wide and 0.30m long, add 0.20m buffer
#             points: "[[0.35, 0.45], [0.35, -0.45], [-0.25, -0.45], [-0.25, 0.45]]"

#         # SLOW ZONE - Reduce speed to 30% (50cm around robot)
#         FootprintSlow:
#             type: "polygon"
#             action_type: "slowdown"
#             min_points: 4
#             visualize: True
#             polygon_pub_topic: "polygon_slow"
#             slowdown_ratio: 0.3
#             # Larger rectangle
#             points: "[[0.65, 0.70], [0.65, -0.70], [-0.45, -0.70], [-0.45, 0.70]]"

#         # APPROACH ZONE - Reduce speed to 70% (80cm around robot)
#         FootprintApproach:
#             type: "polygon"
#             action_type: "approach"
#             min_points: 4
#             visualize: True
#             polygon_pub_topic: "polygon_approach"
#             approach_time_before_collision: 2.0
#             time_before_collision_scale: 0.5
#             # Even larger rectangle
#             points: "[[0.85, 0.90], [0.85, -0.90], [-0.65, -0.90], [-0.65, 0.90]]"
